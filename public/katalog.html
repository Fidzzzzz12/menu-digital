<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Digital - Katalog</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .toko-info h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .toko-info p {
            color: #666;
        }
        
        .categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .product-price {
            color: #007bff;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .add-to-cart {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .add-to-cart:hover {
            background: #0056b3;
        }
        
        .cart {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,123,255,0.3);
            display: none;
        }
        
        .cart.show {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .shipping-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .shipping-method {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .shipping-method.selected {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        
        .shipping-method input[type="radio"] {
            display: none;
        }
        
        .shipping-fields {
            display: none;
        }
        
        .shipping-fields.show {
            display: block;
        }
        
        .btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="toko-info">
                <h1 id="toko-name">Loading...</h1>
                <p id="toko-description">Loading toko information...</p>
            </div>
        </div>
        
        <div class="categories" id="categories">
            <div class="category-btn active" data-category="all">Semua</div>
        </div>
        
        <div class="products" id="products">
            <div class="loading">Loading products...</div>
        </div>
    </div>
    
    <div class="cart" id="cart">
        <span id="cart-count">0</span> Item - Checkout
    </div>
    
    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Checkout</h2>
            
            <form id="checkout-form">
                <div class="form-group">
                    <label>Nama Lengkap *</label>
                    <input type="text" name="nama_lengkap" required>
                </div>
                
                <div class="form-group">
                    <label>WhatsApp *</label>
                    <input type="text" name="whatsapp" required>
                </div>
                
                <div class="form-group">
                    <label>Alamat *</label>
                    <textarea name="alamat" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea name="catatan" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Metode Pengiriman *</label>
                    <div class="shipping-methods">
                        <div class="shipping-method" data-method="dikirim">
                            <input type="radio" name="metode_pengiriman" value="dikirim">
                            <div>üì¶ Dikirim</div>
                        </div>
                        <div class="shipping-method" data-method="ambil_sendiri">
                            <input type="radio" name="metode_pengiriman" value="ambil_sendiri">
                            <div>üè™ Ambil Sendiri</div>
                        </div>
                    </div>
                </div>
                
                <div id="shipping-fields" class="shipping-fields">
                    <div class="form-group">
                        <label>Provinsi</label>
                        <select name="provinsi" id="provinsi">
                            <option value="">Pilih Provinsi</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Kota</label>
                        <select name="kota" id="kota">
                            <option value="">Pilih Kota</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Kurir</label>
                        <select name="kurir" id="kurir">
                            <option value="">Pilih Kurir</option>
                            <option value="jne">JNE</option>
                            <option value="pos">POS Indonesia</option>
                            <option value="tiki">TIKI</option>
                        </select>
                    </div>
                    
                    <button type="button" id="check-ongkir" class="btn">Cek Ongkir</button>
                    
                    <div id="ongkir-results" style="margin-top: 15px;"></div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <div id="order-summary"></div>
                    <button type="submit" class="btn">Pesan Sekarang</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cart = [];
        let tokoData = null;
        let products = [];
        let selectedOngkir = 0;
        
        // Get URL parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Load toko data
        async function loadToko() {
            const urlToko = getUrlParameter('toko') || 'demo-toko';
            
            try {
                const response = await fetch(`/api/katalog/${urlToko}`);
                const data = await response.json();
                
                if (data.success) {
                    tokoData = data.data.toko;
                    products = data.data.products;
                    
                    document.getElementById('toko-name').textContent = tokoData.nama_toko;
                    document.getElementById('toko-description').textContent = tokoData.deskripsi || 'Selamat datang di toko kami';
                    
                    renderCategories(data.data.categories);
                    renderProducts(products);
                } else {
                    document.getElementById('toko-name').textContent = 'Toko tidak ditemukan';
                    document.getElementById('products').innerHTML = '<p>Toko tidak ditemukan</p>';
                }
            } catch (error) {
                console.error('Error loading toko:', error);
                document.getElementById('toko-name').textContent = 'Error loading toko';
                document.getElementById('products').innerHTML = '<p>Error loading data</p>';
            }
        }
        
        // Render categories
        function renderCategories(categories) {
            const container = document.getElementById('categories');
            categories.forEach(category => {
                const btn = document.createElement('div');
                btn.className = 'category-btn';
                btn.textContent = category.nama;
                btn.dataset.category = category.id;
                btn.onclick = () => filterByCategory(category.id);
                container.appendChild(btn);
            });
        }
        
        // Filter products by category
        function filterByCategory(categoryId) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (categoryId === 'all') {
                document.querySelector('[data-category="all"]').classList.add('active');
                renderProducts(products);
            } else {
                document.querySelector(`[data-category="${categoryId}"]`).classList.add('active');
                const filtered = products.filter(p => p.kategori_id == categoryId);
                renderProducts(filtered);
            }
        }
        
        // Render products
        function renderProducts(productList) {
            const container = document.getElementById('products');
            container.innerHTML = '';
            
            productList.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-image">
                        ${product.gambar ? `<img src="/storage/${product.gambar}" alt="${product.nama}" style="width:100%;height:100%;object-fit:cover;">` : 'No Image'}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.nama}</div>
                        <div class="product-price">Rp ${parseInt(product.harga).toLocaleString('id-ID')}</div>
                        <button class="add-to-cart" onclick="addToCart(${product.id}, '${product.nama}', ${product.harga})">
                            Tambah ke Keranjang
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Add to cart
        function addToCart(id, nama, harga) {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                cart.push({ id, nama, harga, quantity: 1 });
            }
            updateCartDisplay();
        }
        
        // Update cart display
        function updateCartDisplay() {
            const cartElement = document.getElementById('cart');
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            if (count > 0) {
                cartElement.classList.add('show');
                document.getElementById('cart-count').textContent = count;
            } else {
                cartElement.classList.remove('show');
            }
        }
        
        // Show checkout modal
        document.getElementById('cart').onclick = function() {
            if (cart.length > 0) {
                document.getElementById('checkout-modal').style.display = 'block';
                updateOrderSummary();
                loadProvinces();
            }
        };
        
        // Close modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('checkout-modal').style.display = 'none';
        };
        
        // Shipping method selection
        document.querySelectorAll('.shipping-method').forEach(method => {
            method.onclick = function() {
                document.querySelectorAll('.shipping-method').forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
                
                const shippingFields = document.getElementById('shipping-fields');
                if (this.dataset.method === 'dikirim') {
                    shippingFields.classList.add('show');
                } else {
                    shippingFields.classList.remove('show');
                    selectedOngkir = 0;
                    updateOrderSummary();
                }
            };
        });
        
        // Load provinces
        async function loadProvinces() {
            try {
                const response = await fetch('/api/v1/provinces');
                const data = await response.json();
                
                const select = document.getElementById('provinsi');
                select.innerHTML = '<option value="">Pilih Provinsi</option>';
                
                if (data.rajaongkir && data.rajaongkir.results) {
                    data.rajaongkir.results.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.province_id;
                        option.textContent = province.province;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
            }
        }
        
        // Load cities when province changes
        document.getElementById('provinsi').onchange = async function() {
            const provinceId = this.value;
            if (!provinceId) return;
            
            try {
                const response = await fetch(`/api/v1/cities/${provinceId}`);
                const data = await response.json();
                
                const select = document.getElementById('kota');
                select.innerHTML = '<option value="">Pilih Kota</option>';
                
                if (data.rajaongkir && data.rajaongkir.results) {
                    data.rajaongkir.results.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.city_id;
                        option.textContent = city.city_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        };
        
        // Check shipping cost
        document.getElementById('check-ongkir').onclick = async function() {
            const kota = document.getElementById('kota').value;
            const kurir = document.getElementById('kurir').value;
            
            if (!kota || !kurir) {
                alert('Pilih kota dan kurir terlebih dahulu');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destination: kota,
                        courier: kurir,
                        weight: 1000
                    })
                });
                
                const data = await response.json();
                const results = document.getElementById('ongkir-results');
                
                if (data.rajaongkir && data.rajaongkir.results[0]) {
                    const services = data.rajaongkir.results[0].costs;
                    results.innerHTML = '<h4>Pilih Layanan:</h4>';
                    
                    services.forEach(service => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding:10px;border:1px solid #ddd;margin:5px 0;cursor:pointer;border-radius:5px;';
                        div.innerHTML = `
                            <strong>${service.service}</strong> - Rp ${service.cost[0].value.toLocaleString('id-ID')}<br>
                            <small>Estimasi: ${service.cost[0].etd} hari</small>
                        `;
                        div.onclick = function() {
                            selectedOngkir = service.cost[0].value;
                            document.querySelectorAll('#ongkir-results > div').forEach(d => d.style.background = '');
                            this.style.background = '#f0f8ff';
                            updateOrderSummary();
                        };
                        results.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Error checking ongkir:', error);
            }
        };
        
        // Update order summary
        function updateOrderSummary() {
            const subtotal = cart.reduce((sum, item) => sum + (item.harga * item.quantity), 0);
            const total = subtotal + selectedOngkir;
            
            document.getElementById('order-summary').innerHTML = `
                <h4>Ringkasan Pesanan:</h4>
                ${cart.map(item => `<div>${item.nama} x${item.quantity} = Rp ${(item.harga * item.quantity).toLocaleString('id-ID')}</div>`).join('')}
                <div style="border-top:1px solid #ddd;padding-top:10px;margin-top:10px;">
                    <div>Subtotal: Rp ${subtotal.toLocaleString('id-ID')}</div>
                    <div>Ongkir: Rp ${selectedOngkir.toLocaleString('id-ID')}</div>
                    <div style="font-weight:bold;font-size:18px;">Total: Rp ${total.toLocaleString('id-ID')}</div>
                </div>
            `;
        }
        
        // Submit order
        document.getElementById('checkout-form').onsubmit = async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            if (!data.metode_pengiriman) {
                alert('Pilih metode pengiriman');
                return;
            }
            
            const orderData = {
                url_toko: tokoData.url_toko,
                nama_lengkap: data.nama_lengkap,
                whatsapp: data.whatsapp,
                alamat: data.alamat,
                catatan: data.catatan,
                metode_pengiriman: data.metode_pengiriman,
                ongkir: selectedOngkir,
                kurir: data.kurir,
                items: cart.map(item => ({
                    produk_id: item.id,
                    nama_produk: item.nama,
                    harga: item.harga,
                    quantity: item.quantity
                }))
            };
            
            try {
                const response = await fetch('/api/pesanan/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Pesanan berhasil dibuat!');
                    cart = [];
                    updateCartDisplay();
                    document.getElementById('checkout-modal').style.display = 'none';
                    
                    // Generate WhatsApp message
                    const message = generateWhatsAppMessage(orderData, result.data);
                    const whatsappUrl = `https://wa.me/${tokoData.whatsapp}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('Terjadi kesalahan saat mengirim pesanan');
            }
        };
        
        // Generate WhatsApp message
        function generateWhatsAppMessage(orderData, resultData) {
            let message = `*PESANAN BARU*\n\n`;
            message += `Nama: ${orderData.nama_lengkap}\n`;
            message += `WhatsApp: ${orderData.whatsapp}\n`;
            message += `Alamat: ${orderData.alamat}\n`;
            if (orderData.catatan) message += `Catatan: ${orderData.catatan}\n`;
            message += `\n*DETAIL PESANAN:*\n`;
            
            orderData.items.forEach(item => {
                message += `‚Ä¢ ${item.nama_produk} x${item.quantity} = Rp ${(item.harga * item.quantity).toLocaleString('id-ID')}\n`;
            });
            
            message += `\nSubtotal: Rp ${resultData.subtotal.toLocaleString('id-ID')}\n`;
            message += `Metode: ${orderData.metode_pengiriman === 'dikirim' ? 'Dikirim' : 'Ambil Sendiri'}\n`;
            if (orderData.metode_pengiriman === 'dikirim') {
                message += `Ongkir: Rp ${orderData.ongkir.toLocaleString('id-ID')}\n`;
            }
            message += `*Total: Rp ${resultData.total_harga.toLocaleString('id-ID')}*`;
            
            return message;
        }
        
        // Initialize
        loadToko();
    </script>
</body>
</html>